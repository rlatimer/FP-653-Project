---
title: "FP 653 Project Script"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
#load librarys 
library(tidyverse)
library(janitor)
library(ggplot2)
library(here)
library(rio)
library(usmap)
library(maps)
library(glue)
library(sp)

```


```{r}
#bring in data

county_sch <- import(here("schools_county_csv2.xlsx")) %>% 
  clean_names() %>%
  as_tibble()

#need the variable 'fips' for mapping
cmap <- rename(county_sch, "fips" = "countyfips4")

#only keep 2020 data
cmap2020 <- 
  cmap %>% 
    filter(year == 2020) %>% 
      group_by(month)

#future notes, potentially merge other datasets usings fips and joins

#we may not need these next two data sets
#district_sch <- import(here("schools_district_csv.csv")) %>% 
#  clean_names() %>%
#  as_tibble()

#state_sch <- import(here("schools_state_csv.csv")) %>% 
#  clean_names() %>%
#  as_tibble()

#check min max of share_all_closed_50 for scaling reasons
min(cmap2020$share_all_closed_50, na.rm = T)
max(cmap2020$share_all_closed_50, na.rm = T)
mean(cmap2020$share_all_closed_50, na.rm = T)
sd(cmap2020$share_all_closed_50, na.rm = T)


```

```{r}
#functions for later
#function1, save plots to a folder 


#function2, convert month numbers into indicative string 

#numbers to month names, not done yet
#numbers to month function, generalized? doesnt work on grouped data 
monthnum_to_names <- function(data, column) {

  check <- with(data, month >= 1 & month <= 12)
  if (unique(check) == "False") {
    return(NA) }
  else {
    return(month.name[column])
  } 
}
monthnum_to_names(table_attendance, table_attendance$month)
#function content check
#check <- with(county_sch, month >= 1 & month <= 12)
# unique(check) == "FALSE"

#checking output  
output <- monthnum_to_names(county_sch, county_sch$month)
typeof(output)

#saving output to original data
county_sch <- mutate(county_sch, month_name = monthnum_to_names(county_sch, county_sch$month))


```


```{r}
#plotting maps

# us map with counties
p <- plot_usmap(regions = "counties", data = cmap2020, values = "share_all_closed_50") + 
  labs(title = "title",
       subtitle = "subtitle here") + 
  theme(panel.background = element_rect(color = "black", fill = "lightblue"))
p
#us map with counties per month
p<-plot_usmap(regions = "counties", data = cmap2020, values = "share_all_closed_50") + 
  scale_fill_continuous(name = "2019 over 2020 change ratio in visits", na.value = "white") +
  facet_wrap(~month) +
  labs(title = glue("Schools experiencing a year-over-year decline of at least 50 percent for month:{cmap2020$month}"), #need to figure out how to glue properly
       subtitle = "subtitle here") + 
  theme(legend.position = "right")
p

#adding state boundaries
states <- plot_usmap(
  "states", 
  color = "black",
  fill = alpha(0.01)
) 

states



#function to output new map for each month? we can do this with facet_wrap
```

```{r}
#saving plots to file


```

```{r}
#shiny app stuff (move over later) to toggle between tables and months??
#table for attendance data, with reactable? meant for shiny app will move it to the app once I know whats going on

library(shiny)
library(reactable)
library(formattable)

table_attendance <- cmap2020 %>% 
  ungroup() %>%
  mutate(month = monthnum_to_names(cmap2020, cmap2020$month)) %>% 
  filter(state_abb == "OR") %>% 
  select(month, county_name, total_students, number_schools, share_all_closed_50, fips) %>% 
  rename("Ratio of Schools with at least 50% vistor decline from 2019" = share_all_closed_50,
         "Month" = month,
         "County Name" = county_name,
         "Total Students" = total_students,
         "Number of Schools" = number_schools)
  
  


ui <- fluidPage(
  reactableOutput("table"), theme = "bootstrap.css"
)

server <- function(input, output) {
  output$table <- renderReactable({
    reactable(table_attendance,
              filterable = TRUE,
              defaultPageSize = 25,
              )
                
              })
}

shinyApp(ui, server)


#probably not gonna use, cant figure out mapping and how to make a spatialpointdataframe
#join county geodata with dataframe 
county_geo <- import("us-county-boundaries.csv") %>%  
  separate(`Geo Point`, into = c("x", "y"), sep = ",") %>% 
   rename("fips" = "GEOID") %>%   
    select(NAME,STATE_NAME, fips, x, y)  
#change data type for join
county_geo$fips <- as.character(county_geo$fips)
county_geo$x <- as.numeric(county_geo$x)
county_geo$y <- as.numeric(county_geo$y)
  
#join data, some countie coordinate data missing 
county_geo_2020 <- left_join(cmap2020,county_geo) %>%  filter(STATE_NAME == "Oregon")

sp_county_geo <- SpatialPoints(county_geo_2020[,26:27], county_geo_2020)


#the other one with maps, trying to show counties on map with share_all_closed
library(crosstalk)
library(leaflet)
library(dplyr)

# A SpatialPointsDataFrame for the map.
# Set a group name to share data points with the table.
share_all_closed_sp <- SharedData$new(county_geo_2020, group = "NAME")

#brew_sp <- SharedData$new(p, group = "breweries")

# A regular data frame (without coordinates) for the table.
# Use the same group name as the map data.
# use non map dataframe for this
share_all_closed_data <- as_tibble(county_geo_2020) %>%
  select(NAME, fips, month, number_schools, total_students, share_all_closed_50) %>% 
  SharedData$new(group = "NAME")

map <- leaflet(share_all_closed_sp) %>%
  addTiles() %>%
  addMarkers(lng = ~x, lat = ~y)

tbl <- reactable(
  share_all_closed_sp,
  selection = "multiple",
  onClick = "select",
  filterable = TRUE,
  rowStyle = list(cursor = "pointer"),
  minRows = 10
)

htmltools::tagList(map, tbl)


```